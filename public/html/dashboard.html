<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard | Sistema de Estoque</title>
  <script src="../js/utils.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="../css/styles.css" />
</head>
<body class="d-flex" data-page="dashboard">
  
  <!-- Sidebar -->
  <div id="navbar-placeholder"></div>
  <script src="../js/navbar.js"></script>

  <div id="page-content" class="flex-grow-1 p-4">
    <h1 class="mb-4">Dashboard Analítico</h1>
    
    <!-- Cards menores no topo -->
    <div class="row g-2 mb-3 justify-content-center" id="dashboard-cards">
      <!-- Cards do dashboard serão preenchidos via JS -->
    </div>

    <div class="row g-4 align-items-stretch" style="min-height: 380px;">
      <!-- Gráfico de Movimentações -->
      <div class="col-lg-7 d-flex">
        <div class="bg-white p-3 rounded-4 shadow-sm flex-fill d-flex flex-column justify-content-center align-items-center" style="height: 380px; min-width: 0;">
          <div class="d-flex justify-content-between align-items-center mb-2 w-100 flex-wrap gap-2">
            <h5 class="mb-0 text-center flex-grow-1">Movimentações</h5>
            <div class="filtro-grafico">
              <label for="filtroPeriodo" class="form-label mb-0 me-2">Período:</label>
              <select id="filtroPeriodo" class="form-select form-select-sm d-inline-block" style="width: auto;">
                <option value="dia">Dia</option>
                <option value="semana">Semana</option>
                <option value="mes" selected>Mês</option>
                <option value="ano">Ano</option>
              </select>
            </div>
          </div>
          <div class="chart-container flex-grow-1 w-100 d-flex align-items-center justify-content-center" style="min-height: 260px;">
            <canvas id="canvas-movimentacoes" width="400" height="260"></canvas>
          </div>
        </div>
      </div>
      <!-- Gráficos de Pizza -->
      <div class="col-lg-5 d-flex flex-column justify-content-between" style="height: 380px;">
        <div class="bg-white p-3 rounded-4 shadow-sm mb-3 flex-fill d-flex flex-column align-items-center justify-content-center" style="min-height: 170px;">
          <h6 class="mb-2 text-center">Produtos com Mais Entradas</h6>
          <canvas id="canvas-mais-entradas" width="180" height="140"></canvas>
        </div>
        <div class="bg-white p-3 rounded-4 shadow-sm flex-fill d-flex flex-column align-items-center justify-content-center" style="min-height: 170px;">
          <h6 class="mb-2 text-center">Produtos com Mais Saídas</h6>
          <canvas id="canvas-mais-saidas" width="180" height="140"></canvas>
        </div>
      </div>
    </div>

    <!-- Relatório no fim da página -->
    <div class="bg-white p-4 rounded-4 shadow-sm mt-4" style="max-width: 700px; margin: 0 auto;">
      <h5 class="mb-3">Relatório</h5>
      <div class="d-flex align-items-center flex-wrap gap-2 mb-2">
        <button id="btn-exportar-csv" class="btn btn-outline-secondary btn-sm me-2" title="Exportar como CSV" aria-label="Exportar como CSV">
          <i class="bi bi-file-earmark-spreadsheet"></i> CSV
        </button>
        <button id="btn-exportar-pdf" class="btn btn-outline-secondary btn-sm me-2">
          <i class="bi bi-file-earmark-pdf"></i> PDF
        </button>
        <label class="d-flex align-items-center mb-0 ms-2">
          <input type="checkbox" id="incluirGrafico" style="margin-right: 8px;" /> Com gráfico
        </label>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="../js/pdf-utils.js"></script>
  <script>
    verificarLogin({ redirect: 'inicio.html', perfilPermitido: ['2', '3'] });
    const token = localStorage.getItem('token');

    // Dashboard cards
    async function carregarDashboard() {
      const cards = [
        { titulo: 'Produtos', valor: '-', cor: 'primary', link: 'listagem.html', texto: 'Ver Todos', icon: 'bi-box-seam' },
        { titulo: 'Estoque Baixo', valor: '-', cor: 'danger', link: 'listagem.html?alerta=1', texto: 'Ver Detalhes', icon: 'bi-exclamation-triangle' },
        { titulo: 'Entradas/Mês', valor: '-', cor: 'success', link: 'historico.html?acao=entrada', texto: 'Ver Entradas', icon: 'bi-arrow-down-circle' },
        { titulo: 'Saídas/Mês', valor: '-', cor: 'warning', link: 'historico.html?acao=saida', texto: 'Ver Saídas', icon: 'bi-arrow-up-circle' }
      ];

      try {
        // Produtos
        const resProdutos = await fetch('https://projeto-estoque-production.up.railway.app/api/produtos', {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (resProdutos.ok) {
          const produtos = await resProdutos.json();
          cards[0].valor = produtos.length;
          cards[1].valor = produtos.filter(p => p.estoque_atual !== null && p.estoque_minimo !== null && p.estoque_atual <= p.estoque_minimo).length;
        }
      } catch {}

      try {
        // Movimentações
        const resMov = await fetch('https://projeto-estoque-production.up.railway.app/api/movimentacoes', {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (resMov.ok) {
          const movs = await resMov.json();
          const mesAtual = new Date().getMonth() + 1;
          const anoAtual = new Date().getFullYear();
          cards[2].valor = movs.filter(m => m.tipo === 'entrada' && new Date(m.created_at).getMonth() + 1 === mesAtual && new Date(m.created_at).getFullYear() === anoAtual).length;
          cards[3].valor = movs.filter(m => m.tipo === 'saida' && new Date(m.created_at).getMonth() + 1 === mesAtual && new Date(m.created_at).getFullYear() === anoAtual).length;
        }
      } catch {}

      document.getElementById('dashboard-cards').innerHTML = cards.map(card => `
        <div class="col-6 col-sm-3">
          <div class="card h-100 border-0 shadow-sm small-card">
            <div class="card-body text-center py-2 px-1">
              <div class="mb-1"><i class="bi ${card.icon} fs-4 text-${card.cor}"></i></div>
              <div class="card-title mb-1 small">${card.titulo}</div>
              <div class="h5 text-${card.cor} mb-1">${card.valor}</div>
              <a href="${card.link}" class="btn btn-xs btn-outline-${card.cor}">${card.texto}</a>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Gráfico dinâmico de movimentações
    let chartMovimentacoes = null;
    let chartMaisEntradas = null;
    let chartMaisSaidas = null;

    async function carregarGraficoMovimentacoes(periodo = 'mes') {
      const res = await fetch('https://projeto-estoque-production.up.railway.app/api/movimentacoes', {
        headers: { Authorization: 'Bearer ' + token }
      });
      if (!res.ok) return;

      const movs = await res.json();
      const now = new Date();
      let labels = [], entradas = [], saidas = [];

      // Filtros para pizza
      let filtroMovs = [];
      if (periodo === 'dia') {
        labels = Array.from({length: 24}, (_, i) => `${i}:00`);
        entradas = Array(24).fill(0);
        saidas = Array(24).fill(0);
        filtroMovs = movs.filter(mov => new Date(mov.created_at).toDateString() === now.toDateString());
        filtroMovs.forEach(mov => {
          const d = new Date(mov.created_at);
          if (mov.tipo === 'entrada') entradas[d.getHours()] += mov.quantidade;
          if (mov.tipo === 'saida') saidas[d.getHours()] += mov.quantidade;
        });
      } else if (periodo === 'semana') {
        const dias = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
        labels = dias;
        entradas = Array(7).fill(0);
        saidas = Array(7).fill(0);
        const startOfWeek = new Date(now);
        startOfWeek.setDate(now.getDate() - now.getDay());
        filtroMovs = movs.filter(mov => {
          const d = new Date(mov.created_at);
          const diff = Math.floor((d - startOfWeek) / (1000 * 60 * 60 * 24));
          return diff >= 0 && diff < 7 && d.getFullYear() === now.getFullYear();
        });
        filtroMovs.forEach(mov => {
          const d = new Date(mov.created_at);
          if (mov.tipo === 'entrada') entradas[d.getDay()] += mov.quantidade;
          if (mov.tipo === 'saida') saidas[d.getDay()] += mov.quantidade;
        });
      } else if (periodo === 'ano') {
        labels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
        entradas = Array(12).fill(0);
        saidas = Array(12).fill(0);
        filtroMovs = movs.filter(mov => new Date(mov.created_at).getFullYear() === now.getFullYear());
        filtroMovs.forEach(mov => {
          const d = new Date(mov.created_at);
          if (mov.tipo === 'entrada') entradas[d.getMonth()] += mov.quantidade;
          if (mov.tipo === 'saida') saidas[d.getMonth()] += mov.quantidade;
        });
      } else { // mês
        const diasNoMes = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
        labels = Array.from({length: diasNoMes}, (_, i) => `${i + 1}`);
        entradas = Array(diasNoMes).fill(0);
        saidas = Array(diasNoMes).fill(0);
        filtroMovs = movs.filter(mov => {
          const d = new Date(mov.created_at);
          return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        });
        filtroMovs.forEach(mov => {
          const d = new Date(mov.created_at);
          if (mov.tipo === 'entrada') entradas[d.getDate() - 1] += mov.quantidade;
          if (mov.tipo === 'saida') saidas[d.getDate() - 1] += mov.quantidade;
        });
      }

      // Gráfico de barras
      const ctx = document.getElementById('canvas-movimentacoes').getContext('2d');
      if (chartMovimentacoes) chartMovimentacoes.destroy();
      chartMovimentacoes = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Entradas', data: entradas, backgroundColor: 'rgba(25, 135, 84, 0.7)', borderColor: '#198754', borderWidth: 1 },
            { label: 'Saídas', data: saidas, backgroundColor: 'rgba(255, 193, 7, 0.7)', borderColor: '#ffc107', borderWidth: 1 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' }
          },
          scales: {
            x: { grid: { color: '#f0f0f0' } },
            y: { beginAtZero: true, grid: { color: '#f0f0f0' } }
          }
        }
      });

      // Gráfico de pizza - Mais Entradas
      const entradasPorProduto = {};
      filtroMovs.filter(m => m.tipo === 'entrada').forEach(m => {
        entradasPorProduto[m.produto_nome] = (entradasPorProduto[m.produto_nome] || 0) + m.quantidade;
      });
      const topEntradas = Object.entries(entradasPorProduto)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 6);
      const ctxEntradas = document.getElementById('canvas-mais-entradas').getContext('2d');
      if (chartMaisEntradas) chartMaisEntradas.destroy();
      chartMaisEntradas = new Chart(ctxEntradas, {
        type: 'pie',
        data: {
          labels: topEntradas.map(e => e[0]),
          datasets: [{
            data: topEntradas.map(e => e[1]),
            backgroundColor: [
              '#198754', '#20c997', '#0dcaf0', '#ffc107', '#fd7e14', '#dc3545'
            ]
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      // Gráfico de pizza - Mais Saídas
      const saidasPorProduto = {};
      filtroMovs.filter(m => m.tipo === 'saida').forEach(m => {
        saidasPorProduto[m.produto_nome] = (saidasPorProduto[m.produto_nome] || 0) + m.quantidade;
      });
      const topSaidas = Object.entries(saidasPorProduto)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 6);
      const ctxSaidas = document.getElementById('canvas-mais-saidas').getContext('2d');
      if (chartMaisSaidas) chartMaisSaidas.destroy();
      chartMaisSaidas = new Chart(ctxSaidas, {
        type: 'pie',
        data: {
          labels: topSaidas.map(e => e[0]),
          datasets: [{
            data: topSaidas.map(e => e[1]),
            backgroundColor: [
              '#dc3545', '#fd7e14', '#ffc107', '#0dcaf0', '#20c997', '#198754'
            ]
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    document.getElementById('btn-exportar-csv').addEventListener('click', async () => {
      const res = await fetch('https://projeto-estoque-production.up.railway.app/api/movimentacoes', {
        headers: { Authorization: 'Bearer ' + token }
      });
      if (!res.ok) return alert('Erro ao buscar dados');
      const movs = await res.json();

      let csv = 'Data,Produto,Tipo,Quantidade,Responsável\n';
      movs.forEach(mov => {
        csv += `"${new Date(mov.created_at).toLocaleDateString('pt-BR')}","${mov.produto_nome}","${mov.tipo}","${mov.quantidade}","${mov.responsavel_nome}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'relatorio_movimentacoes.csv';
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('btn-exportar-pdf').addEventListener('click', () => {
      const incluirGrafico = document.getElementById('incluirGrafico').checked;
      exportarDashboardParaPDF({ incluirGrafico });
    });

    document.getElementById('filtroPeriodo').addEventListener('change', function() {
      carregarGraficoMovimentacoes(this.value);
    });

    document.getElementById('dashboard-cards').addEventListener('click', function(e) {
      const btn = e.target.closest('a');
      if (!btn) return;
      // Todos os links já levam para o destino correto via href
    });

    carregarDashboard();
    carregarGraficoMovimentacoes();
  </script>
</body>
</html>